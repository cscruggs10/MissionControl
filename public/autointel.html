<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoIntel - Auction Intelligence</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      color: #111827;
      overflow-x: hidden;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 250px;
      background: #1f2937;
      color: white;
      padding: 1.5rem;
      z-index: 1000;
    }

    .sidebar-header {
      margin-bottom: 2rem;
    }

    .sidebar-header h1 {
      font-size: 1.5rem;
      color: #667eea;
      margin-bottom: 0.25rem;
    }

    .sidebar-header p {
      font-size: 0.875rem;
      color: #9ca3af;
    }

    .sidebar-nav {
      list-style: none;
    }

    .sidebar-nav li {
      margin-bottom: 0.5rem;
    }

    .sidebar-nav a {
      display: block;
      padding: 0.75rem 1rem;
      color: #d1d5db;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .sidebar-nav a:hover {
      background: #374151;
      color: white;
    }

    .sidebar-nav a.active {
      background: #667eea;
      color: white;
    }

    /* Main Content */
    .main-content {
      margin-left: 250px;
      padding: 2rem;
      min-height: 100vh;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h2 {
      font-size: 2rem;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .page-header p {
      color: #6b7280;
    }

    /* Calendar/Runlist Grid */
    .auction-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .auction-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .auction-info h3 {
      font-size: 1.25rem;
      color: #111827;
      margin-bottom: 0.25rem;
    }

    .auction-info p {
      color: #6b7280;
      font-size: 0.875rem;
    }

    .auction-date {
      text-align: right;
      color: #667eea;
      font-weight: 600;
    }

    /* Vehicle Table */
    .vehicle-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .vehicle-table th {
      text-align: left;
      padding: 0.75rem 0.5rem;
      border-bottom: 2px solid #e5e7eb;
      color: #6b7280;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .vehicle-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid #f3f4f6;
    }

    .vehicle-table tr:hover {
      background: #f9fafb;
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.in-lane {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.proxy {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.pass {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-info {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }

    /* Dashboard Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stat-card h4 {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>AutoIntel</h1>
      <p>Auction Intelligence</p>
    </div>
    <ul class="sidebar-nav">
      <li><a href="#" data-page="dashboard" class="active">ðŸ“Š Dashboard</a></li>
      <li><a href="#" data-page="calendar">ðŸ“… AutoIntel Calendar</a></li>
      <li><a href="#" data-page="in-lane">ðŸŽ¯ In-Lane Bids</a></li>
      <li><a href="#" data-page="proxy">ðŸ¤– Proxy Bids</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Dashboard Page -->
    <div id="dashboard-page" class="page active">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>Overview of your auction activity</p>
      </div>
      <div class="stats-grid" id="dashboard-stats">
        <div class="loading">Loading statistics...</div>
      </div>
    </div>

    <!-- Calendar Page -->
    <div id="calendar-page" class="page">
      <div class="page-header">
        <h2>AutoIntel Calendar</h2>
        <p>Upcoming auctions and runlists</p>
      </div>
      <div id="calendar-content">
        <div class="loading">Loading auctions...</div>
      </div>
    </div>

    <!-- In-Lane Bids Page -->
    <div id="in-lane-page" class="page">
      <div class="page-header">
        <h2>In-Lane Bids</h2>
        <p>Vehicles you'll bid on manually</p>
      </div>
      <div id="in-lane-content">
        <div class="loading">Loading in-lane bids...</div>
      </div>
    </div>

    <!-- Proxy Bids Page -->
    <div id="proxy-page" class="page">
      <div class="page-header">
        <h2>Proxy Bids</h2>
        <p>Vehicles with automated max bids</p>
      </div>
      <div id="proxy-content">
        <div class="loading">Loading proxy bids...</div>
      </div>
    </div>
  </div>

  <script>
    // Navigation
    const navLinks = document.querySelectorAll('.sidebar-nav a');
    const pages = document.querySelectorAll('.page');

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const pageId = link.dataset.page;
        
        // Update active nav link
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        // Show selected page
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`${pageId}-page`).classList.add('active');
        
        // Load page content
        loadPage(pageId);
      });
    });

    // Load page content
    async function loadPage(pageId) {
      switch(pageId) {
        case 'dashboard':
          await loadDashboard();
          break;
        case 'calendar':
          await loadCalendar();
          break;
        case 'in-lane':
          await loadInLane();
          break;
        case 'proxy':
          await loadProxy();
          break;
      }
    }

    // Load Dashboard
    async function loadDashboard() {
      try {
        const response = await fetch('/api/runlists');
        const data = await response.json();
        
        const statsHtml = `
          <div class="stat-card">
            <h4>Total Runlists</h4>
            <div class="value">${data.runlists.length}</div>
          </div>
          <div class="stat-card">
            <h4>In-Lane Bids</h4>
            <div class="value" id="in-lane-count">-</div>
          </div>
          <div class="stat-card">
            <h4>Proxy Bids</h4>
            <div class="value" id="proxy-count">-</div>
          </div>
        `;
        
        document.getElementById('dashboard-stats').innerHTML = statsHtml;
        
        // Load bid counts
        const inLaneResp = await fetch('/api/bid-list/in-lane-dashboard');
        const inLaneData = await inLaneResp.json();
        document.getElementById('in-lane-count').textContent = inLaneData.total_vehicles;
        
        const proxyResp = await fetch('/api/bid-list/proxy-dashboard');
        const proxyData = await proxyResp.json();
        document.getElementById('proxy-count').textContent = proxyData.total_vehicles;
        
      } catch (err) {
        console.error('Load dashboard error:', err);
        document.getElementById('dashboard-stats').innerHTML = '<div class="empty-state">Error loading dashboard</div>';
      }
    }

    // Load Calendar
    async function loadCalendar() {
      try {
        const response = await fetch('/api/runlists');
        const data = await response.json();
        
        if (data.runlists.length === 0) {
          document.getElementById('calendar-content').innerHTML = '<div class="empty-state">No auctions found</div>';
          return;
        }
        
        let html = '';
        
        for (const runlist of data.runlists) {
          // Get vehicles for this runlist
          const vehiclesResp = await fetch(`/api/runlist/${runlist.id}`);
          const vehiclesData = await vehiclesResp.json();
          
          // Get bid status for this runlist
          const bidsResp = await fetch(`/api/bid-list/runlist/${runlist.id}`);
          const bidsData = await bidsResp.json();
          
          html += renderAuctionCard(runlist, vehiclesData.vehicles, bidsData.bids);
        }
        
        document.getElementById('calendar-content').innerHTML = html;
        
        // Attach event listeners
        attachBidButtonListeners();
        
      } catch (err) {
        console.error('Load calendar error:', err);
        document.getElementById('calendar-content').innerHTML = '<div class="empty-state">Error loading calendar</div>';
      }
    }

    // Render auction card
    function renderAuctionCard(runlist, vehicles, bids) {
      const date = new Date(runlist.auction_date).toLocaleDateString();
      
      let vehiclesHtml = vehicles.slice(0, 20).map(vehicle => {
        const bid = bids[vehicle.id];
        const statusHtml = bid ? renderBidStatus(bid) : '';
        
        return `
          <tr>
            <td>${vehicle.year || 'N/A'}</td>
            <td>${vehicle.make || 'N/A'}</td>
            <td>${vehicle.model || 'N/A'}</td>
            <td>${vehicle.vin || 'N/A'}</td>
            <td>${vehicle.lane || 'N/A'}</td>
            <td>
              ${statusHtml}
              <div class="action-buttons" data-vehicle-id="${vehicle.id}" data-auction-id="${runlist.id}">
                ${!bid ? `
                  <button class="btn btn-primary btn-small add-in-lane">+ In-Lane</button>
                  <button class="btn btn-success btn-small add-proxy">+ Proxy</button>
                  <button class="btn btn-secondary btn-small add-pass">Pass</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      return `
        <div class="auction-card">
          <div class="auction-card-header">
            <div class="auction-info">
              <h3>${runlist.auction_name || 'Unknown Auction'}</h3>
              <p>${runlist.name} â€¢ ${vehicles.length} vehicles</p>
            </div>
            <div class="auction-date">${date}</div>
          </div>
          <table class="vehicle-table">
            <thead>
              <tr>
                <th>Year</th>
                <th>Make</th>
                <th>Model</th>
                <th>VIN</th>
                <th>Lane</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${vehiclesHtml}
            </tbody>
          </table>
        </div>
      `;
    }

    // Render bid status
    function renderBidStatus(bid) {
      const badgeClass = bid.bid_type.replace('-', '');
      const label = bid.bid_type === 'in-lane' ? 'In-Lane' : 
                    bid.bid_type === 'proxy' ? 'Proxy' : 'Pass';
      
      let maxBidInfo = '';
      if (bid.bid_type === 'proxy' && bid.max_bid) {
        maxBidInfo = ` â€¢ $${parseFloat(bid.max_bid).toLocaleString()}`;
      }
      
      return `
        <div>
          <span class="status-badge ${badgeClass}">${label}</span>
          <div class="status-info">Added by ${bid.created_by}${maxBidInfo}</div>
        </div>
      `;
    }

    // Load In-Lane Dashboard
    async function loadInLane() {
      try {
        const response = await fetch('/api/bid-list/in-lane-dashboard');
        const data = await response.json();
        
        if (data.auctions.length === 0) {
          document.getElementById('in-lane-content').innerHTML = '<div class="empty-state">No in-lane bids yet</div>';
          return;
        }
        
        let html = '';
        data.auctions.forEach(auction => {
          html += renderBidDashboard(auction, 'in-lane');
        });
        
        document.getElementById('in-lane-content').innerHTML = html;
        
      } catch (err) {
        console.error('Load in-lane error:', err);
        document.getElementById('in-lane-content').innerHTML = '<div class="empty-state">Error loading in-lane bids</div>';
      }
    }

    // Load Proxy Dashboard
    async function loadProxy() {
      try {
        const response = await fetch('/api/bid-list/proxy-dashboard');
        const data = await response.json();
        
        if (data.auctions.length === 0) {
          document.getElementById('proxy-content').innerHTML = '<div class="empty-state">No proxy bids yet</div>';
          return;
        }
        
        let html = '';
        data.auctions.forEach(auction => {
          html += renderBidDashboard(auction, 'proxy');
        });
        
        document.getElementById('proxy-content').innerHTML = html;
        
      } catch (err) {
        console.error('Load proxy error:', err);
        document.getElementById('proxy-content').innerHTML = '<div class="empty-state">Error loading proxy bids</div>';
      }
    }

    // Render bid dashboard
    function renderBidDashboard(auction, type) {
      const date = new Date(auction.auction_date).toLocaleDateString();
      
      let vehiclesHtml = auction.vehicles.map(vehicle => {
        const maxBidCol = type === 'proxy' ? 
          `<td>$${parseFloat(vehicle.max_bid).toLocaleString()}</td>` : '';
        
        return `
          <tr>
            <td>${vehicle.lane || 'N/A'}</td>
            <td>${vehicle.run_number || 'N/A'}</td>
            <td>${vehicle.year || 'N/A'}</td>
            <td>${vehicle.make || 'N/A'}</td>
            <td>${vehicle.model || 'N/A'}</td>
            <td>${vehicle.trim}</td>
            <td>${vehicle.miles}</td>
            <td>${vehicle.vin}</td>
            <td>${vehicle.cr}</td>
            ${maxBidCol}
            <td>
              <button class="btn btn-secondary btn-small remove-bid" data-bid-id="${vehicle.bid_id}">Remove</button>
            </td>
          </tr>
        `;
      }).join('');
      
      const maxBidHeader = type === 'proxy' ? '<th>Max Bid</th>' : '';
      
      return `
        <div class="auction-card">
          <div class="auction-card-header">
            <div class="auction-info">
              <h3>${auction.auction_house || 'Unknown Auction'}</h3>
              <p>${auction.auction_name} â€¢ ${auction.vehicles.length} vehicles</p>
            </div>
            <div class="auction-date">${date}</div>
          </div>
          <table class="vehicle-table">
            <thead>
              <tr>
                <th>Lane</th>
                <th>Run#</th>
                <th>Year</th>
                <th>Make</th>
                <th>Model</th>
                <th>Trim</th>
                <th>Miles</th>
                <th>VIN</th>
                <th>CR</th>
                ${maxBidHeader}
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${vehiclesHtml}
            </tbody>
          </table>
        </div>
      `;
    }

    // Add bid
    async function addBid(vehicleId, auctionId, bidType) {
      let maxBid = null;
      
      if (bidType === 'proxy') {
        maxBid = prompt('Enter max bid amount:');
        if (!maxBid || isNaN(maxBid) || parseFloat(maxBid) <= 0) {
          alert('Please enter a valid max bid amount');
          return;
        }
      }
      
      try {
        const response = await fetch('/api/bid-list/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vehicle_id: vehicleId,
            auction_id: auctionId,
            bid_type: bidType,
            max_bid: maxBid
          })
        });
        
        if (response.ok) {
          // Reload calendar
          loadCalendar();
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (err) {
        console.error('Add bid error:', err);
        alert('Error adding bid');
      }
    }

    // Remove bid
    async function removeBid(bidId) {
      if (!confirm('Remove this bid?')) return;
      
      try {
        const response = await fetch(`/api/bid-list/${bidId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          // Reload current page
          const activePage = document.querySelector('.sidebar-nav a.active').dataset.page;
          loadPage(activePage);
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (err) {
        console.error('Remove bid error:', err);
        alert('Error removing bid');
      }
    }

    // Attach button listeners
    function attachBidButtonListeners() {
      document.querySelectorAll('.add-in-lane').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const container = e.target.closest('.action-buttons');
          addBid(container.dataset.vehicleId, container.dataset.auctionId, 'in-lane');
        });
      });
      
      document.querySelectorAll('.add-proxy').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const container = e.target.closest('.action-buttons');
          addBid(container.dataset.vehicleId, container.dataset.auctionId, 'proxy');
        });
      });
      
      document.querySelectorAll('.add-pass').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const container = e.target.closest('.action-buttons');
          addBid(container.dataset.vehicleId, container.dataset.auctionId, 'pass');
        });
      });
      
      document.querySelectorAll('.remove-bid').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeBid(e.target.dataset.bidId);
        });
      });
    }

    // Initialize
    loadDashboard();
  </script>
</body>
</html>
