<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoIntel - Auction Intelligence</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #667eea; margin-bottom: 0.5rem; font-size: 2rem; }
    h2 { color: #374151; margin-bottom: 1rem; font-size: 1.25rem; }
    .subtitle { color: #666; margin-bottom: 2rem; }
    .step { display: none; }
    .step.active { display: block; }
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      gap: 1rem;
    }
    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e5e7eb;
    }
    .step-dot.active { background: #667eea; }
    .step-dot.completed { background: #10b981; }
    .upload-section {
      border: 2px dashed #667eea;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-section:hover { border-color: #764ba2; background: #f9fafb; }
    .upload-section.dragover { border-color: #10b981; background: #ecfdf5; }
    input[type="file"] { display: none; }
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
    input[type="text"], input[type="date"], select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .row { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    button {
      padding: 0.75rem 1.5rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #764ba2; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    button.secondary { background: #6b7280; }
    button.success { background: #10b981; }
    button.small { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .button-row { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .button-row button { flex: 1; }
    .file-info {
      margin-top: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
      text-align: left;
    }
    .progress { margin-top: 1.5rem; }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #10b981;
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text { margin-top: 0.5rem; color: #666; font-size: 0.9rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: #f9fafb; padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-card .value { font-size: 2rem; font-weight: bold; color: #667eea; }
    .stat-card .label { color: #666; font-size: 0.9rem; }
    .stat-card.highlight { background: #ecfdf5; border: 2px solid #10b981; }
    .stat-card.highlight .value { color: #10b981; }
    .vehicle-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    .vehicle-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .vehicle-item:last-child { border-bottom: none; }
    .vehicle-item .info { font-weight: 500; }
    .vehicle-item .meta { color: #666; font-size: 0.85rem; }
    .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .badge.strong { background: #3b82f6; color: white; }
    .error {
      margin-top: 1rem;
      padding: 1rem;
      background: #fef2f2;
      border-radius: 8px;
      border-left: 4px solid #ef4444;
      color: #991b1b;
    }
    .results {
      margin-top: 2rem;
      padding: 1rem;
      background: #ecfdf5;
      border-radius: 8px;
      border-left: 4px solid #10b981;
    }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #374151; }
    .mapping-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .mapping-item { display: flex; align-items: center; gap: 0.5rem; }
    .mapping-item label { min-width: 120px; margin-bottom: 0; }
    .mapping-item select { flex: 1; }
    .required-label::after { content: ' *'; color: #ef4444; }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 { margin-bottom: 1.5rem; }
    .auction-select-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }
    .auction-select-row .form-group { flex: 1; margin-bottom: 0; }
    .sample-data {
      background: #f9fafb;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      overflow-x: auto;
    }
    .sample-data table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .sample-data th, .sample-data td {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      text-align: left;
    }
    .sample-data th { background: #667eea; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h1>AutoIntel</h1>
      <a href="/calendar.html" style="background: #667eea; color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: 600;">Calendar View</a>
    </div>
    <p class="subtitle">Upload runlists, match against history, enrich with announcement data</p>

    <div class="step-indicator">
      <div class="step-dot active" id="dot1"></div>
      <div class="step-dot" id="dot2"></div>
      <div class="step-dot" id="dot3"></div>
    </div>

    <!-- Step 1: Upload -->
    <div class="step active" id="step1">
      <h2>Step 1: Upload Runlist</h2>

      <div class="upload-section" id="uploadZone">
        <div id="uploadPrompt">
          <h3 style="color: #667eea; margin-bottom: 0.5rem;">Drop CSV file here</h3>
          <p style="color: #666;">or click to browse</p>
        </div>
        <div id="fileInfo" class="file-info" style="display: none;"></div>
        <input type="file" id="fileInput" accept=".csv">
      </div>

      <div class="row">
        <div class="form-group">
          <label for="auctionSelect">Auction</label>
          <div class="auction-select-row">
            <div class="form-group">
              <select id="auctionSelect">
                <option value="">-- Select Auction --</option>
              </select>
            </div>
            <button type="button" class="small" id="addAuctionBtn">+ New</button>
          </div>
        </div>
        <div class="form-group">
          <label for="auctionDate">Auction Date</label>
          <input type="date" id="auctionDate" required>
        </div>
      </div>

      <button id="uploadBtn" disabled style="width: 100%;">Upload & Match Against History</button>

      <div class="progress" id="uploadProgress" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="uploadProgressFill"></div>
        </div>
        <div class="progress-text" id="uploadProgressText">Uploading...</div>
      </div>

      <div class="error" id="uploadError" style="display: none;"></div>
    </div>

    <!-- Step 2: Review Matches -->
    <div class="step" id="step2">
      <h2>Step 2: Review Matches</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="value" id="totalCount">0</div>
          <div class="label">Total Vehicles</div>
        </div>
        <div class="stat-card highlight">
          <div class="value" id="matchedCount">0</div>
          <div class="label">Matched (to enrich)</div>
        </div>
        <div class="stat-card">
          <div class="value" id="unmatchedCount">0</div>
          <div class="label">No History</div>
        </div>
      </div>

      <p class="section-title">Matched Vehicles (will be enriched with announcements)</p>
      <div class="vehicle-list" id="matchedList"></div>

      <div class="button-row">
        <button class="secondary" id="backBtn">Back</button>
        <button class="success" id="scrapeBtn">Enrich Matched Vehicles</button>
      </div>
    </div>

    <!-- Step 3: Enriching -->
    <div class="step" id="step3">
      <h2>Step 3: Enriching Data</h2>

      <div class="progress" id="scrapeProgress">
        <div class="progress-bar" style="height: 20px; border-radius: 10px;">
          <div class="progress-fill" id="scrapeProgressFill" style="border-radius: 10px;"></div>
        </div>
        <div class="progress-text" id="scrapeProgressText">Initializing...</div>
      </div>

      <div class="results" id="scrapeResults" style="display: none;"></div>

      <!-- Results Table -->
      <div id="enrichedResults" style="display: none; margin-top: 1.5rem;">
        <div class="stats-grid" style="margin-bottom: 1rem;">
          <div class="stat-card">
            <div class="value" id="enrichedTotal">0</div>
            <div class="label">Total</div>
          </div>
          <div class="stat-card highlight">
            <div class="value" id="enrichedCount">0</div>
            <div class="label">Enriched</div>
          </div>
          <div class="stat-card" style="background: #fef2f2; border: 2px solid #ef4444;">
            <div class="value" id="flaggedCount" style="color: #ef4444;">0</div>
            <div class="label">Flagged</div>
          </div>
        </div>

        <div style="overflow-x: auto; max-height: 400px; border: 1px solid #e5e7eb; border-radius: 8px;">
          <table id="resultsTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead style="position: sticky; top: 0; background: #667eea; color: white;">
              <tr>
                <th style="padding: 0.75rem; text-align: center;">Lane-Run</th>
                <th style="padding: 0.75rem; text-align: left;">VIN</th>
                <th style="padding: 0.75rem; text-align: left;">Vehicle</th>
                <th style="padding: 0.75rem; text-align: center;">Grade</th>
                <th style="padding: 0.75rem; text-align: left;">Announcements</th>
                <th style="padding: 0.75rem; text-align: center;">Flags</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="button-row" id="finishButtons" style="display: none;">
        <button class="secondary" id="newUploadBtn">Upload Another</button>
        <button class="success" id="exportBtn">Export CSV</button>
      </div>
    </div>
  </div>

  <!-- Add Auction Modal -->
  <div class="modal-overlay" id="addAuctionModal">
    <div class="modal">
      <h2>Add New Auction Format</h2>

      <div id="modalStep1">
        <div class="form-group">
          <label for="newAuctionName">Auction Name</label>
          <input type="text" id="newAuctionName" placeholder="e.g., Manheim Little Rock">
        </div>

        <div class="upload-section" id="sampleUploadZone">
          <div id="sampleUploadPrompt">
            <h3 style="color: #667eea; margin-bottom: 0.5rem;">Upload Sample CSV</h3>
            <p style="color: #666;">to detect column names</p>
          </div>
          <input type="file" id="sampleFileInput" accept=".csv">
        </div>

        <div class="error" id="modalError" style="display: none;"></div>

        <div class="button-row">
          <button class="secondary" id="cancelModalBtn">Cancel</button>
          <button id="detectColumnsBtn" disabled>Detect Columns</button>
        </div>
      </div>

      <div id="modalStep2" style="display: none;">
        <p style="margin-bottom: 1rem;">Map your CSV columns to vehicle fields:</p>

        <div class="sample-data" id="sampleDataPreview"></div>

        <h3 style="margin: 1.5rem 0 1rem;">Required Fields</h3>
        <div class="mapping-grid" id="requiredMappings"></div>

        <h3 style="margin: 1.5rem 0 1rem;">Optional Fields</h3>
        <div class="mapping-grid" id="optionalMappings"></div>

        <div class="error" id="mappingError" style="display: none;"></div>

        <div class="button-row">
          <button class="secondary" id="backToStep1Btn">Back</button>
          <button class="success" id="saveMappingBtn">Save Auction Format</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const fileInfo = document.getElementById('fileInfo');
    const auctionSelect = document.getElementById('auctionSelect');
    const auctionDate = document.getElementById('auctionDate');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadProgressFill = document.getElementById('uploadProgressFill');
    const uploadProgressText = document.getElementById('uploadProgressText');
    const uploadError = document.getElementById('uploadError');
    const addAuctionBtn = document.getElementById('addAuctionBtn');

    const backBtn = document.getElementById('backBtn');
    const scrapeBtn = document.getElementById('scrapeBtn');
    const matchedList = document.getElementById('matchedList');

    const scrapeProgressFill = document.getElementById('scrapeProgressFill');
    const scrapeProgressText = document.getElementById('scrapeProgressText');
    const scrapeResults = document.getElementById('scrapeResults');
    const finishButtons = document.getElementById('finishButtons');
    const newUploadBtn = document.getElementById('newUploadBtn');

    // Modal elements
    const addAuctionModal = document.getElementById('addAuctionModal');
    const newAuctionName = document.getElementById('newAuctionName');
    const sampleUploadZone = document.getElementById('sampleUploadZone');
    const sampleFileInput = document.getElementById('sampleFileInput');
    const detectColumnsBtn = document.getElementById('detectColumnsBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const modalStep1 = document.getElementById('modalStep1');
    const modalStep2 = document.getElementById('modalStep2');
    const requiredMappings = document.getElementById('requiredMappings');
    const optionalMappings = document.getElementById('optionalMappings');
    const saveMappingBtn = document.getElementById('saveMappingBtn');
    const backToStep1Btn = document.getElementById('backToStep1Btn');
    const sampleDataPreview = document.getElementById('sampleDataPreview');

    let selectedFile = null;
    let sampleFile = null;
    let currentRunlistId = null;
    let currentStep = 1;
    let detectedColumns = [];

    const requiredFields = ['vin', 'year', 'make', 'model'];
    const optionalFields = ['lane', 'lot', 'lane_run'];

    // Initialize
    auctionDate.valueAsDate = new Date();
    loadAuctionFormats();

    // Load auction formats
    async function loadAuctionFormats() {
      try {
        const response = await fetch('/api/auction-formats');
        const data = await response.json();

        auctionSelect.innerHTML = '<option value="">-- Select Auction --</option>';
        for (const format of data.formats) {
          const option = document.createElement('option');
          option.value = format.auction_name;
          option.textContent = format.auction_name;
          auctionSelect.appendChild(option);
        }
      } catch (err) {
        console.error('Failed to load auction formats:', err);
      }
    }

    // Step management
    function goToStep(step) {
      currentStep = step;
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('active', i + 1 === step);
      });
      document.querySelectorAll('.step-dot').forEach((el, i) => {
        el.classList.remove('active', 'completed');
        if (i + 1 === step) el.classList.add('active');
        if (i + 1 < step) el.classList.add('completed');
      });
    }

    // Upload zone
    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (!file.name.endsWith('.csv')) {
        showUploadError('Please select a CSV file');
        return;
      }
      selectedFile = file;
      uploadPrompt.style.display = 'none';
      fileInfo.style.display = 'block';
      fileInfo.innerHTML = `<strong>File:</strong> ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      checkForm();
    }

    auctionSelect.addEventListener('change', checkForm);
    auctionDate.addEventListener('input', checkForm);

    function checkForm() {
      uploadBtn.disabled = !(selectedFile && auctionSelect.value && auctionDate.value);
    }

    function showUploadError(msg) {
      uploadError.style.display = 'block';
      uploadError.textContent = msg;
    }

    // Upload & Match
    uploadBtn.addEventListener('click', async () => {
      uploadBtn.disabled = true;
      uploadProgress.style.display = 'block';
      uploadError.style.display = 'none';
      uploadProgressFill.style.width = '30%';
      uploadProgressText.textContent = 'Uploading file...';

      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('auction_name', auctionSelect.value);
      formData.append('auction_date', auctionDate.value);

      try {
        uploadProgressFill.style.width = '60%';
        uploadProgressText.textContent = 'Matching against historical data...';

        const response = await fetch('/api/runlist/upload', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        uploadProgressFill.style.width = '100%';
        uploadProgressText.textContent = 'Complete!';

        currentRunlistId = data.runlist.id;
        setTimeout(() => loadRunlistResults(currentRunlistId), 500);

      } catch (err) {
        showUploadError(err.message);
        uploadBtn.disabled = false;
        uploadProgress.style.display = 'none';
      }
    });

    async function loadRunlistResults(runlistId) {
      try {
        const response = await fetch(`/api/runlist/${runlistId}`);
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to load results');

        document.getElementById('totalCount').textContent = data.stats.total;
        document.getElementById('matchedCount').textContent = data.stats.matched;
        document.getElementById('unmatchedCount').textContent = data.stats.unmatched;

        const matched = data.vehicles.filter(v => v.matched);
        matchedList.innerHTML = matched.length > 0
          ? matched.map(v => `
              <div class="vehicle-item">
                <div>
                  <div class="info">${v.year} ${v.make} ${v.model}</div>
                  <div class="meta">VIN: ${v.vin} | ${v.mileage ? v.mileage.toLocaleString() + ' mi' : 'N/A'}</div>
                </div>
                <span class="badge strong">${v.match_count} matches</span>
              </div>
            `).join('')
          : '<div class="vehicle-item"><div class="info">No matches found</div></div>';

        scrapeBtn.disabled = matched.length === 0;
        goToStep(2);

      } catch (err) {
        showUploadError(err.message);
      }
    }

    // Back button
    backBtn.addEventListener('click', () => {
      goToStep(1);
      uploadProgress.style.display = 'none';
      uploadBtn.disabled = false;
    });

    // Enrich button
    scrapeBtn.addEventListener('click', async () => {
      goToStep(3);
      scrapeProgressFill.style.width = '0%';
      scrapeProgressText.textContent = 'Connecting to AutoNiq...';
      scrapeResults.style.display = 'none';
      finishButtons.style.display = 'none';
      document.getElementById('enrichedResults').style.display = 'none';

      try {
        const response = await fetch(`/api/runlist/${currentRunlistId}/scrape`, { method: 'POST' });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Enrichment failed');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n').filter(l => l.trim());

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.progress !== undefined) {
                scrapeProgressFill.style.width = data.progress + '%';
                let message = data.message || `${data.progress}%`;
                message = message.replace(/Scraping/gi, 'Enriching').replace(/scraping/gi, 'enriching');
                scrapeProgressText.textContent = message;
              }
              if (data.complete) {
                scrapeResults.style.display = 'block';
                scrapeResults.innerHTML = `
                  <h3 style="color: #10b981; margin-bottom: 1rem;">Enrichment Complete</h3>
                  <p><strong>Processed:</strong> ${data.processed} vehicles</p>
                  <p><strong>Errors:</strong> ${data.errors}</p>
                  <p><strong>Duration:</strong> ${data.duration}s</p>
                `;
                // Load enriched results
                await loadEnrichedResults();
                finishButtons.style.display = 'flex';
              }
              if (data.error) throw new Error(data.error);
            }
          }
        }
      } catch (err) {
        scrapeProgressText.textContent = 'Error: ' + err.message;
        finishButtons.style.display = 'flex';
      }
    });

    // Load and display enriched results
    async function loadEnrichedResults() {
      try {
        const response = await fetch(`/api/runlist/${currentRunlistId}/enriched`);
        const data = await response.json();

        document.getElementById('enrichedTotal').textContent = data.stats.total;
        document.getElementById('enrichedCount').textContent = data.stats.enriched;
        document.getElementById('flaggedCount').textContent = data.stats.flagged;

        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = data.vehicles.map(v => {
          const gradeColor = v.grade ? (v.grade <= 2 ? '#ef4444' : v.grade <= 3 ? '#f59e0b' : '#10b981') : '#999';
          const flagBadges = v.flags.map(f => `<span style="background:#fef2f2;color:#ef4444;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-right:4px;">${f}</span>`).join('');
          const announcements = (v.announcements || '').replace(/\|/g, '; ').replace(/\*\*/g, '');
          const laneRun = v.lane && v.lot ? `${v.lane}-${v.lot}` : (v.lane || v.lot || '-');

          return `
            <tr style="border-bottom: 1px solid #e5e7eb; ${v.flags.length > 0 ? 'background:#fef2f2;' : ''}">
              <td style="padding: 0.5rem; text-align: center; font-weight: bold;">${laneRun}</td>
              <td style="padding: 0.5rem; font-family: monospace; font-size: 0.75rem;">${v.vin}</td>
              <td style="padding: 0.5rem;">${v.year} ${v.make} ${v.model}</td>
              <td style="padding: 0.5rem; text-align: center;">
                <span style="background: ${gradeColor}; color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold;">
                  ${v.grade || 'N/A'}
                </span>
              </td>
              <td style="padding: 0.5rem; font-size: 0.8rem; max-width: 300px;">${announcements || '-'}</td>
              <td style="padding: 0.5rem; text-align: center;">${flagBadges || '-'}</td>
            </tr>
          `;
        }).join('');

        document.getElementById('enrichedResults').style.display = 'block';
      } catch (err) {
        console.error('Failed to load enriched results:', err);
      }
    }

    // Export CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      window.location.href = `/api/runlist/${currentRunlistId}/export`;
    });

    // New upload
    newUploadBtn.addEventListener('click', () => {
      selectedFile = null;
      currentRunlistId = null;
      fileInput.value = '';
      uploadPrompt.style.display = 'block';
      fileInfo.style.display = 'none';
      auctionSelect.value = '';
      auctionDate.valueAsDate = new Date();
      uploadBtn.disabled = true;
      uploadProgress.style.display = 'none';
      uploadError.style.display = 'none';
      document.getElementById('enrichedResults').style.display = 'none';
      goToStep(1);
    });

    // Modal functionality
    addAuctionBtn.addEventListener('click', () => {
      addAuctionModal.classList.add('active');
      modalStep1.style.display = 'block';
      modalStep2.style.display = 'none';
      newAuctionName.value = '';
      sampleFile = null;
      detectColumnsBtn.disabled = true;
    });

    cancelModalBtn.addEventListener('click', closeModal);

    function closeModal() {
      addAuctionModal.classList.remove('active');
      sampleFile = null;
      newAuctionName.value = '';
    }

    sampleUploadZone.addEventListener('click', () => sampleFileInput.click());
    sampleFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        sampleFile = e.target.files[0];
        document.getElementById('sampleUploadPrompt').innerHTML = `
          <strong>File:</strong> ${sampleFile.name}
        `;
        checkModalForm();
      }
    });

    newAuctionName.addEventListener('input', checkModalForm);

    function checkModalForm() {
      detectColumnsBtn.disabled = !(sampleFile && newAuctionName.value.trim());
    }

    detectColumnsBtn.addEventListener('click', async () => {
      const formData = new FormData();
      formData.append('file', sampleFile);

      try {
        document.getElementById('modalError').style.display = 'none';
        detectColumnsBtn.disabled = true;
        detectColumnsBtn.textContent = 'Detecting...';

        const response = await fetch('/api/csv/detect-columns', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        detectedColumns = data.columns;
        showMappingUI(data.columns, data.sampleData);

      } catch (err) {
        document.getElementById('modalError').style.display = 'block';
        document.getElementById('modalError').textContent = err.message;
      } finally {
        detectColumnsBtn.disabled = false;
        detectColumnsBtn.textContent = 'Detect Columns';
      }
    });

    function showMappingUI(columns, sampleData) {
      modalStep1.style.display = 'none';
      modalStep2.style.display = 'block';

      // Show sample data preview
      let tableHtml = '<table><tr>';
      columns.forEach(col => tableHtml += `<th>${col}</th>`);
      tableHtml += '</tr>';
      sampleData.slice(0, 2).forEach(row => {
        tableHtml += '<tr>';
        columns.forEach(col => tableHtml += `<td>${row[col] || ''}</td>`);
        tableHtml += '</tr>';
      });
      tableHtml += '</table>';
      sampleDataPreview.innerHTML = tableHtml;

      // Build mapping selects
      const optionsHtml = '<option value="">-- Skip --</option>' +
        columns.map(c => `<option value="${c}">${c}</option>`).join('');

      requiredMappings.innerHTML = requiredFields.map(field => `
        <div class="mapping-item">
          <label class="required-label">${formatFieldName(field)}</label>
          <select id="map_${field}">${optionsHtml}</select>
        </div>
      `).join('');

      optionalMappings.innerHTML = optionalFields.map(field => `
        <div class="mapping-item">
          <label>${formatFieldName(field)}</label>
          <select id="map_${field}">${optionsHtml}</select>
        </div>
      `).join('');

      // Auto-detect common columns
      autoDetectColumns(columns);
    }

    function formatFieldName(field) {
      return field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function autoDetectColumns(columns) {
      const mappings = {
        vin: ['vin', 'vin_number', 'vehicle_vin'],
        year: ['year', 'model_year', 'yr'],
        make: ['make', 'manufacturer'],
        model: ['model', 'vehicle_model'],
        lane: ['lane'],
        lot: ['lot']
      };

      for (const [field, aliases] of Object.entries(mappings)) {
        const select = document.getElementById(`map_${field}`);
        if (!select) continue;

        for (const col of columns) {
          if (aliases.some(a => col.toLowerCase().includes(a))) {
            select.value = col;
            break;
          }
        }
      }
    }

    backToStep1Btn.addEventListener('click', () => {
      modalStep1.style.display = 'block';
      modalStep2.style.display = 'none';
    });

    saveMappingBtn.addEventListener('click', async () => {
      const mappings = {};

      // Collect all mappings
      for (const field of [...requiredFields, ...optionalFields]) {
        const select = document.getElementById(`map_${field}`);
        if (select && select.value) {
          mappings[field] = select.value;
        }
      }

      // Validate required fields
      for (const field of requiredFields) {
        if (!mappings[field]) {
          document.getElementById('mappingError').style.display = 'block';
          document.getElementById('mappingError').textContent = `Please map the required field: ${formatFieldName(field)}`;
          return;
        }
      }

      try {
        document.getElementById('mappingError').style.display = 'none';
        saveMappingBtn.disabled = true;
        saveMappingBtn.textContent = 'Saving...';

        const response = await fetch('/api/auction-formats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            auction_name: newAuctionName.value.trim(),
            column_mappings: mappings
          })
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        // Reload auction formats and select the new one
        await loadAuctionFormats();
        auctionSelect.value = newAuctionName.value.trim();
        checkForm();
        closeModal();

      } catch (err) {
        document.getElementById('mappingError').style.display = 'block';
        document.getElementById('mappingError').textContent = err.message;
      } finally {
        saveMappingBtn.disabled = false;
        saveMappingBtn.textContent = 'Save Auction Format';
      }
    });
  </script>
</body>
</html>
